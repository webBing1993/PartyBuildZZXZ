{extend name="public/common"}

{block name="style"}
<link rel="stylesheet" href="/home/css/mediation/application.css">
<link rel="stylesheet" href="/home/css/mediation/iosselect.css">
<link rel="stylesheet" href="/home/css/easy_upload.css">
<title>事件申请</title>
<style>
    .shadow{
        display:none;
        position: fixed;
        left:0;
        top:0;
        width:100%;
        height:100%;
        background: rgba(0,0,0,.5);
        z-index: 1000;
    }
    .user {position: relative;width:100vw;margin: auto;background: #fff;}
    .user li {width:100%;padding: 2.25vh 4vw;height:13.5vh;border-bottom: 1px solid #d1d1d1;position: relative;}
    .user li:last-child {border-bottom: transparent;}
    .user li img {float:left;width:1.2rem;height:1.2rem;}
    .userSort {margin-left: 1.5rem;position: relative;height:1.2rem;}
    .userSort p:first-child {color: #333;font-size: .3rem;position: absolute;top:0;}
    .userSort p:last-child {color: #999;font-size: .26rem;position: absolute;bottom:0;}

    .user a {
        display: block;
        position: absolute;
        top: 50%;
        right: 4vw;
        width: 24vw;
        height: .6rem;
        border: 1px solid #FE8B44;
        color: #FE8B44;
        background: rgba(254, 139, 68, .2);
        border-radius: .4rem;
        text-align: center;
        line-height: .6rem;
        font-size: .3rem;
        margin-top: -.3rem;
    }
    .med .last_ts {
        color: #999;
    }
    .pro{
        width:45vw;
        display: -webkit-box;
        -webkit-box-orient: vertical;
        -webkit-line-clamp: 1;
        overflow: hidden;
    }
</style>
{/block}
{block name="body"}
<div class="form">
    <div class="box">
        <div class="ev">
            <img class="star" src="/home/images/lxyz/icon/star.png"  alt=""/>
            <span>事件名称 ：</span>
        </div>
        <input type="text" placeholder="请输入事件名称" size="28" name="name"/>
    </div>
    <div class="box">
        <div class="ev">
            <img class="star" src="/home/images/lxyz/icon/star.png"  alt=""/>
            <span>当事人 ：</span>
        </div>
        <input  type="text" placeholder="请输入当事人名称" size="28" name="people"/>
    </div>
    <div class="box">
        <div class="ev">
            <img class="star"  src="/home/images/lxyz/icon/star.png"  alt=""/>
            <span>申请人 ：</span>
        </div>
        <input type="text"  placeholder="请输入申请人名称" size="30" name="thing" value="{$model['name']}"/>
    </div>
    <div class="box">
        <div class="ev">
            <img class="star"  src="/home/images/lxyz/icon/star.png"  alt=""/>
            <span>联系电话 ：</span>
        </div>
        <input type="number"  placeholder="请输入联系电话" size="28" style="text-indent: .5vw;" id="phone" name="num" value="{$model['mobile']}">
    </div>
    <div class="describe">
        <textarea name="content" id="text" placeholder="请对您的纠纷进行描述" maxlength="1000"></textarea>
        <!--<div id="easyContainer"></div>-->
        <div class="imgs clear">
            <div class="img fl hide"><div class="x"><img class="im2" src="/home/images/chacha.png"/></div></div>
            <div class="img fl hide"><div class="x"><img class="im2" src="/home/images/chacha.png"/></div></div>
            <div class="img fl hide"><div class="x"><img class="im2" src="/home/images/chacha.png"/></div></div>
            <div class="img fl hide"><div class="x"><img class="im2" src="/home/images/chacha.png"/></div></div>
            <div class="add">
                <div class="new">
                    <img class="newimg" src="/home/images/lxyz/icon/new.png"  alt=""/>
                </div>
            </div>
            <input type="file" class="hide" id="upimg" accept="image/*">
        </div>
        <p>请上传您的证据，（可为空，限4张，限5M）</p>
    </div>
    <div class="box last">
        <img class="star"  src="/home/images/lxyz/icon/star.png"  alt=""/>
        <span>选择调解员 :</span>
        <div class="med">
            <span hidden class="last_ts">请选择调解员</span>

            <img class="image" src="{$mediator_path}"  alt=""/>
            <span class="name">{$mediator}</span>
            <span class="g">
                <img class="icon2"  src="/home/images/lxyz/icon/icon2.png"  alt=""/>
            </span>
        </div>

    </div>
</div>
<div class="present">
    提交申请
</div>
<div class="shadow">
    <div class="user">
        <ul>
            {volist name="list" id="vo"}
            <li>
                <span class="user_hide" hidden>{$vo.userid}</span>
                <img src="{$vo.front_cover|get_cover='path'}">
                <div class="userSort">
                    <p class="na">{$vo.name}</p>
                    <p class="pro">{$vo.description}</p>
                </div>
                <a href="#">找{eq name="$vo.gender" value="1"}他{else/}她{/eq}调解</a>
            </li>
            {/volist}
        </ul>
    </div>
</div>

<div class="showbox">
    <div class="loader">
        <svg class="circular" viewBox="25 25 50 50">
            <circle class="path" cx="50" cy="50" r="20" fill="none" stroke-width="2" stroke-miterlimit="10"/>
        </svg>
    </div>
</div>
{/block}

{block name="script"}
<script>
     if($(window).width()>=768){
         $('.form').css('margin-bottom','11.5vh')
     }
     var id;
     var href = window.location.href;
     if (href.indexOf("id/") < 0) {
         $(".med .image,.med .name").hide();
         $(".last_ts").show();
         click();
     }else {
         $(".med .image,.med .name").show();
         $(".last_ts").hide();
         id = '{$mediatorid}';
         click();
     };
     function click() {
         $('.last').on('click',function(){
             $('.shadow').fadeIn();
         });
     }
    $('.shadow').on('click',function(e){
        e.preventDefault();
        $('.shadow').fadeOut();
    });

    $('.user li').each(function(){
        $(this).find('a').on('click',function(e){
            e.preventDefault();
            var src=$(this).parent().find('img').attr('src');
            var name=$(this).parent().find('.na').html();
            $(".last_ts").hide();
            $('.image').attr('src',src).show();
            $('.name').html(name).show();
            setTimeout(function(){
                $('.shadow').fadeOut()
            },800);
            id = $(this).siblings(".user_hide").html();
        })
    });
    $(function(){
        //上传
        $('.present' ).on('click',function(){
            var single = false;
            var title=$("input[name='name']").val();
            var parties=$("input[name='people']").val();
            var proposer=$("input[name='thing']").val();
            var mobile= $("input[name='num']").val();
            var content=$("textarea[name='content']").val();
            var images = new Array();
            if(title != "" && parties != "" && proposer != "" && mobile != "" && content != "" && id != undefined ){
               single = true;
            }else{
                single = false;
                swal({
                    title: ' ',
                    text: '您还没有完成编辑！',
                    type: 'error',
                    confirmButtonText:'确定',
                    timer: 1500
                })
            }
//            console.log(data)
            if(single){
                $(".img .img1").each(function(){
                    if($(this).data("tab")){
                        images.push($(this).data("tab")+"");
                    }
                });
                if ($(".img .img1").length == 0) {
                    images='';
                }
                var data={
                    title: title,
                    parties: parties,
                    proposer: proposer,
                    mobile: mobile,
                    content: content,
                    mediatorid : id,
                    images: images
                };
                console.log(data)
                // 弹窗
                swal({
                        title: ' ',
                        text: '我已完成编辑，马上发送！',
                        type: 'success',
                        showCancelButton: true,
                        confirmButtonText:'确定',
                        cancelButtonText: "取消",
                        closeOnConfirm: false
                    },
                    function(){
                        $(".sweet-alert .sa-confirm-button-container").css("display","none");
                        swal({
                            title: ' ',
                            text: '发送中...',
                            type: 'success',
                            timer:1500
                        });
                        setTimeout(function () {
                            $.ajax({
                                type:"post",
                                url: "{:Url('Mediation/application')}",
                                data:data,
                                success:function(data){
                                    if (data.code == 1) {
                                        history.go(-1);
                                    }
                                }
                            });
                        },1500)
                    });
            }
        });
        //--------------------------------------------------------------------------
        //
        // 清除同一张图片再次上传bug
        function clearImg() {
            $("input[type = 'file']").remove();
        }

        function addImg() {
            var addImg = '<input type="file" class="hide" id="upimg" accept="image/*">';
            $(".imgs").append(addImg);
        }

        //--------------------------------------------------------------------------
//            图片预览
        $('.new' ).on('click',function(){
            var imglen = $('.img  .img1' ).length;
            var ua = navigator.userAgent.toLowerCase();
            var isiOS = (ua.indexOf('iphone') != -1) || (ua.indexOf('ipad') != -1);  // ios终端
            if(!isiOS){
                $(this).next("input").attr('capture','camera');
            }
            $('#upimg').click().off("change").on('change',function(){
                var size = ($(this)[0].files[0].size / 1024).toFixed(2);
                if(size <= 5120){
                    var img = $(this)[0].files[0];
                    var formData = new FormData();
                    formData.append("picture",img);
                    $.ajax({
                        type: "post",
                        url: "{:Url('File/uploadPicture')}",
                        data: formData,
                        processData : false,
                        contentType : false,
                        beforeSend: function(XMLHttpRequest){
                            $('.showbox').show();
                        },
                        success:function(data){
                            $('.showbox').hide();
                            clearImg();
                            var msg = $.parseJSON(data);
                            if(msg.code == 1){
                                //图片添加
                                if(imglen == 3){
                                    $('.add' ).hide()
                                }
                                $('.img').eq(imglen).removeClass('hide' )
                                        .append('<img class="img1" src='+msg.data.path+' alt="笔记图片" data-tab='+msg.data.id+'>');
                                if(imglen>=0){
//                                    添加删除按钮
                                    $('.x').on('click',function(){
                                        $(this).parents(".img").remove();
                                        $('.add').before('<div class="img fl hide"><div class="x"><img class="im2" src="/home/images/chacha.png"/></div></div>');
                                        if(imglen<4){
                                            $('.add' ).show();
                                        }
                                    })
                                }
                                imgresize();

                            } else {
                                swal({
                                    title: ' ',
                                    html: '上传失败',
                                    type: 'error',
                                    showConfirmButton:false,
                                    timer:1500
                                });
                            }
                            addImg();
                        }
                    });
                } else {
                    clearImg();
                    swal({
                        title: ' ',
                        text: '您的图片超过5M',
                        type: 'warning',
                        showConfirmButton:false,
                        timer:1500
                    });
                    addImg();
                }
            });

        });

        // 字数限定
        numlimit(400)
    });
    function imgresize(){
        setTimeout(function(){
            var img = $('.img .img1' );
            img.each(function(){
                if($(this).width() == $(this).height()){
                    $(this).height('17.3vw');
                    $(this).width('17.3vw');
                }else if($(this).width() > $(this).height()){
                    $(this).height('20.8vw' ).css({'left':-$(this).width()/2+78/2});
                }else{
                    $(this).width('20.8vw').css({'top':-$(this).height()/2+78/2});
                }
            });
        },100);
    }
    function numlimit(n){
        var textarea = $('textarea');
        var lock = false;
        textarea.on('compositionstart',function(){
            lock = true;
        });
        textarea.on('compositionend',function(){
            lock = false;
        });
        textarea.on('input',function(){
            if(!lock){
                //键盘输入
                var text = $(this).val();
                text = text.substring(0,n);
                var num = text.length;
                $(this).val(text);
                $('.contentnum span').text(num);
            }
        });
        textarea.bind("paste",function(){
            //黏贴输入
            var text = $(this).val();
            text = text.substring(0,n);
            var num = text.length;
            $(this).val(text);
            $('.contentnum span').text(num);
        }).css("ime-mode", "disabled"); //CSS设置输入法不可用
    }
</script>
{/block}