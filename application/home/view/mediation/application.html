{extend name="public/common"}

{block name="style"}
<link rel="stylesheet" href="/home/css/mediation/application.css">
<link rel="stylesheet" href="/home/css/mediation/iosselect.css">
<link rel="stylesheet" href="/home/css/easy_upload.css">
<title>事件申请</title>
{/block}
{block name="body"}
<div class="form">
    <div class="box">
        <div class="ev">
            <img class="star" src="/home/images/lxyz/icon/star.png"  alt=""/>
            <span>事件名称 ：</span>
        </div>
        <input type="text" placeholder="请输入事件名称" size="28" name="name"/>
    </div>
    <!--<div class="box events">-->
    <!--<div class="ev">-->
    <!--<img class="star" src="/home/images/lxyz/icon/star.png"  alt=""/>-->
    <!--<span>事件类型 ：</span>-->
    <!--</div>-->
    <!--<div class="event" id="showBank">-->
    <!--&lt;!&ndash;<span class="chose"> 请选择事件类型</span>&ndash;&gt;-->
    <!--<img class="icon3" src="/home/images/lxyz/icon/icon3.png"  alt=""/>-->
    <!--<div class="pc-box">-->
    <!--<input type="hidden" name="bank_id" id="bankId" value="">-->
    <!--<span >请选择事件类型</span>-->
    <!--</div>-->
    <!--</div>-->
    <!--</div>-->
    <div class="box">
        <div class="ev">
            <img class="star" src="/home/images/lxyz/icon/star.png"  alt=""/>
            <span>当事人 ：</span>
        </div>
        <input  type="text" placeholder="请输入当事人名称" size="28" name="people"/>
    </div>
    <div class="box">
        <div class="ev">
            <img class="star"  src="/home/images/lxyz/icon/star.png"  alt=""/>
            <span>申请人 ：</span>
        </div>
        <input type="text"  placeholder="请输入申请人名称" size="30" name="thing"/>
    </div>
    <div class="box">
        <div class="ev">
            <img class="star"  src="/home/images/lxyz/icon/star.png"  alt=""/>
            <span>联系电话 ：</span>
        </div>
        <input type="number"  placeholder="请输入联系电话" size="28" style="text-indent: .5vw;" id="phone" name="num">
    </div>
    <div class="describe">
        <textarea name="content" id="text" placeholder="请对您的纠纷进行描述" maxlength="1000"></textarea>
        <!--<div id="easyContainer"></div>-->
        <div class="imgs clear">
            <div class="img fl hide"><div class="x"><img class="im2" src="/home/images/chacha.png"/></div></div>
            <div class="img fl hide"><div class="x"><img class="im2" src="/home/images/chacha.png"/></div></div>
            <div class="img fl hide"><div class="x"><img class="im2" src="/home/images/chacha.png"/></div></div>
            <div class="img fl hide"><div class="x"><img class="im2" src="/home/images/chacha.png"/></div></div>
            <div class="add">
                <div class="new">
                    <img class="newimg" src="/home/images/lxyz/icon/new.png"  alt=""/>
                </div>
            </div>
            <input type="file" class="hide" id="upimg" accept="image/*">
        </div>
        <p>请上传您的证据，（可为空，限4张）</p>
    </div>
    <div class="box last">
        <img class="star"  src="/home/images/lxyz/icon/star.png"  alt=""/>
        <span>选择调解员 :</span>
        <div class="med">
            <img class="image" src="/home/images/lxyz/icon/not.png"  alt=""/>
            <span class="name">芊芊</span>
            <span class="g">
                <img class="icon2"  src="/home/images/lxyz/icon/icon2.png"  alt=""/>
            </span>
        </div>
    </div>
</div>
<div class="present">
    提交申请
</div>
<!--<div class="container"></div>-->
{/block}

{block name="script"}
<script>

    $('.last').on('click',function(){
        window.location.href='/home/mediation/applicationdetail.html'
    });
    $(function(){
        //上传
        $('.present' ).on('click',function(){
            var single = false;
            if($("input[name='name']").val() != "" ||$("input[name='people']").val() != "" ||$("input[name='thing']").val() != ""||$("input[name='num']").val() != ""||$("textarea[name='content']").val()!="" ){
                single = true
            }else{
                single = false;
                swal({
                    title: ' ',
                    text: '您还没有完成编辑！',
                    type: 'error',
                    confirmButtonText:'确定',
                    timer: 1500
                })
            }
            var data={
                name: $("input[name='name']").val(),
                people: $("input[name='people']").val(),
                thing: $("input[name='thing']").val(),
                num: $("input[name='num']").val(),
                content: $("textarea[name='content']").val(),
                status: 3
            };
            if(single){
                data['list_images']=[];
                $(".img img").each(function(){
                    if($(this).data("tab")){
                        data['list_images'].push($(this).data("tab")+"");
                    }
                });
                // 弹窗
                swal({
                        title: ' ',
                        text: '我已完成编辑，马上发送！',
                        type: 'success',
                        showCancelButton: true,
                        confirmButtonText:'确定',
                        cancelButtonText: "取消",
                        closeOnConfirm: false
                    },
                    function(){
                        $(".sweet-alert .sa-confirm-button-container").css("display","none");
                        swal({
                            title: ' ',
                            text: '发送中...',
                            type: 'success',
                            timer:1500
                        });
                        setTimeout(function () {
                            console.log(data);
                            $.ajax({
                                type:"post",
//                                    url: "{:Url('Feedback/publish')}",
                                data:data,
                                success:function(data){
                                    setTimeout(function(){
//                                            window.location.href = "{:Url('Feedback/index')}";
                                    },800);
                                }
                            });
                        },1500)
                    });
            }
        });
        //--------------------------------------------------------------------------
        //
        // 清除同一张图片再次上传bug
        function clearImg() {
            $("input[type = 'file']").remove();
        }

        function addImg() {
            var addImg = '<input type="file" class="hide" id="upimg" accept="image/*">';
            $(".imgs").append(addImg);
        }

        //--------------------------------------------------------------------------
//            图片预览
        $('.new' ).on('click',function(){
            var imglen = $('.img  .img1' ).length;
            var loading = $('.loading');
            var ua = navigator.userAgent.toLowerCase();
            var isiOS = (ua.indexOf('iphone') != -1) || (ua.indexOf('ipad') != -1);  // ios终端
            if(!isiOS){
                $(this).next("input").attr('capture','camera');
            }
            $('#upimg').click().off("change").on('change',function(){
                var size = ($(this)[0].files[0].size / 1024).toFixed(2);
                if(size <= 5120){
                    var img = $(this)[0].files[0];
                    var formData = new FormData();
                    formData.append("picture",img);
                    $.ajax({
                        type: "post",
                        url: "{:Url('File/uploadPicture')}",
                        data: formData,
                        processData : false,
                        contentType : false,
                        beforeSend: function(XMLHttpRequest){
                            loading.toggleClass('hidden');
                        },
                        success:function(data){
                            console.log(data)
                            clearImg();
                            var msg = $.parseJSON(data);
                            loading.toggleClass('hidden');
                            if(msg.code == 1){
                                //图片添加
                                if(imglen == 3){
                                    $('.add' ).hide()
                                }
                                $('.img').eq(imglen).removeClass('hide' )
                                        .append('<img class="img1" src='+msg.data.path+' alt="笔记图片" data-tab='+msg.data.id+'>');
                                if(imglen>=0){
                                    $('.x').on('click',function(){
                                        $(this).parents(".img").remove();
                                        $('.add').before('<div class="img fl hide"><div class="x"><img class="im2" src="/home/images/chacha.png"/></div></div>')
                                        if(imglen<4){
                                            $('.add' ).show();
                                        }
                                    })
                                }
                                imgresize();

                            } else {
                                swal({
                                    title: ' ',
                                    html: '上传失败',
                                    type: 'error',
                                    showConfirmButton:false,
                                    timer:1500
                                });
                            }
                            addImg();
                        }
                    });
                } else {
                    clearImg();
                    swal({
                        title: ' ',
                        text: '您的图片超过5M',
                        type: 'warning',
                        showConfirmButton:false,
                        timer:1500
                    });
                    addImg();
                }
            });

        });

        // 字数限定
        numlimit(400)
    });
    function imgresize(){
        setTimeout(function(){
            var img = $('.img .img1' );
            img.each(function(){
                if($(this).width() == $(this).height()){
                    $(this).height('17.3vw');
                    $(this).width('17.3vw');
                }else if($(this).width() > $(this).height()){
                    $(this).height('20.8vw' ).css({'left':-$(this).width()/2+78/2});
                }else{
                    $(this).width('20.8vw').css({'top':-$(this).height()/2+78/2});
                }
            });
        },100);
    }
    function numlimit(n){
        var textarea = $('textarea');
        var lock = false;
        textarea.on('compositionstart',function(){
            lock = true;
        });
        textarea.on('compositionend',function(){
            lock = false;
        });
        textarea.on('input',function(){
            if(!lock){
                //键盘输入
                var text = $(this).val();
                text = text.substring(0,n);
                var num = text.length;
                $(this).val(text);
                $('.contentnum span').text(num);
            }
        });
        textarea.bind("paste",function(){
            //黏贴输入
            var text = $(this).val();
            text = text.substring(0,n);
            var num = text.length;
            $(this).val(text);
            $('.contentnum span').text(num);
        }).css("ime-mode", "disabled"); //CSS设置输入法不可用
    }
</script>
{/block}