{extend name="public/common"}

{block name="style"}
<title>红色电影</title>
<!--<link rel="stylesheet" href="/home/css/redcollection/film.css">-->
<link rel="stylesheet" href="/home/css/education/index.css">
<style>
	.search {
		position: relative;
		top: 0;
		left: 0;
		width: 100vw;
		height: 44px;
		background: #f1f1f1;
	}
	.search input {
		position: absolute;
		top: 1.6vw;
		left: 3vw;
		width: 94vw;
		height: 8.6vw;
		padding-left: 8vw;
		-webkit-border-radius: 2.2vw;
		border-radius: 2.2vw;
		font-size: .3rem;
	}
	.search .fa-search {
		z-index: 1;
		position: absolute;
		top: 4vw;
		left: 6vw;
		color: #aeaeae;
		font-size: .3rem;
	}
</style>
{/block}

{block name="body"}
<div class="search">
	<span class="fa fa-search"></span>
	<input type="text" placeholder="输入电影名称">
</div>
<div class="results"></div>
<div class="lists-title clear">
	经典热播
</div>
<div class="side1_lists">
	<ul>
		{volist name="list" id="vo"}
		<li>
			<a href="{:Url('Redcollection/filmdetail?id='.$vo['id'])}" class="list">
				<img data-original="{$vo.front_cover|get_cover='path'}" class="list-img lazy">
				<div class="listTitle">{$vo.title}</div><div class="listSummary">{$vo.introduction}</div>
			</a>
		</li>
		{/volist}
	</ul>
</div>
<div class="tip"></div>
<div class="loading hidden">
	<div class="typing_loader"></div>
</div>
{/block}

{block name="script"}
<script>
$(function(){
	//搜索
	var search = $('.search>input');
	var lock = false;
	search.on('compositionstart',function(){
		lock = true;
	});
	search.on('compositionend',function(){
		lock = false;
	});
	search.on('input',function(){
		var this_ = this;
		if(!lock){
			var val = $(this_ ).val();
			var html = '';
			$.ajax({
				type:"post",
				url: "{:Url('Redcollection/filmserch')}",
				data:{
					val:val
				},
				beforeSend: function(XMLHttpRequest){},
				success:function(data){
					var result = data.data;
					var url = '';
					if(!data.data){
						html +=
								'<div class="result limit">无搜索结果</div>'
					}
					for(var obj in result){
						html+= '<a href=\"/home/Redcollection/filmdetail?id='+obj+'\" class="result limit">'+result[obj]+'</a>';
					}
					$('.results' ).html(html);
				}

			});
		}
	});
})

var scrollNow = true;
var len = $(".side1_lists li").length;
if (len >= 5) {
    $('.tip').text('上拉加载更多');
} else {
    $('.tip').hide()
}
loadScroll();

function loadScroll(){
    $(window ).off("scroll" ).on("scroll",function(){
        var dh = $(document).height();
        var end = $(window).height() + $(window ).scrollTop();
        var len = $(".side1_lists li").length;
        var tip = $(".tip");
        var loading = $('.loading');
        if(dh == end && scrollNow){
            scrollNow = false;
            $.ajax({
                type:"post",
                url:"{:Url('education/moremove')}",
                data:{
                    length:len
                },
                beforeSend: function(XMLHttpRequest){
                    tip.hide();
                    loading.toggleClass('hidden');
                },
                success:function(data){
                    loading.toggleClass('hidden');
                    tip.show();
                    if(data.code == 1){
                        console.log(data)
                        addCourse(data);
                        var dataLen =data.data.length;
                        if(data.data.length == 5){
                            tip.text('上拉加载更多');
                        }
                        $("img.lazy").lazyload({
                            placeholder: "/home/images/loading.jpg",
                            effect: "fadeIn",
                            threshold: 1
                        });
                    }else{
                        tip.text('没有更多了');
                        $(window ).off("scroll");
                    }
                    scrollNow = true;
                }
            })
        }
    })
}
function addCourse(data){
    var html = '';
    var lists = data.data;
    var len = lists.length;
    for(var i = 0; i< len;i++){
        var list = lists[i];
        html +='<li>'
        		+'<a href="/home/redcollection/filmdetail?id='+list.id+'" class="list">'
        		+'<img data-original="'+list.path+'" class="list-img lazy">'
        		+'<div class="listTitle">'+list.title+'</div><div class="listSummary">'+list.introduction+'</div>'
        		+'</a>'
				+'</li>'
    }
    $(".side1_lists ul" ).append(html);
}
</script>
{/block}