{extend name="public/common"}

{block name="style"}
<link rel="stylesheet" href="/home/css/mediation/application.css">
<link rel="stylesheet" href="/home/css/easy_upload.css">
<title>我来推荐</title>
<style>
    /*body {background: #eee;}*/
    /*.Upload {width:100vw;padding: 4vw;background: #fff;}*/
    /*.Upload textarea {font-size: .3rem;height:3.5rem;resize: none;width:100%;text-align: justify;}*/
    /*.sweet-alert h2{*/
        /*font-size: .4rem;*/
    /*}*/
    .describe{
        margin:0;
    }
</style>
{/block}
{block name="body"}
<div class="describe">
    <textarea name="content" id="text" placeholder="请您对党员的优秀事迹进行简要描述" maxlength="1000"></textarea>
    <!--<div id="easyContainer"></div>-->
    <div class="imgs clear">
        <div class="img fl hide"><div class="x"><img class="im2" src="/home/images/chacha.png"/></div></div>
        <div class="img fl hide"><div class="x"><img class="im2" src="/home/images/chacha.png"/></div></div>
        <div class="img fl hide"><div class="x"><img class="im2" src="/home/images/chacha.png"/></div></div>
        <div class="img fl hide"><div class="x"><img class="im2" src="/home/images/chacha.png"/></div></div>
        <div class="add">
            <div class="new">
                <img class="newimg" src="/home/images/lxyz/icon/new.png"  alt=""/>
            </div>
        </div>
        <input type="file" class="hide" id="upimg" accept="image/*">
    </div>
    <p>请上传您的证据，（可为空，限4张,限5M）</p>
</div>
<div class="present">
    提交
</div>
<div class="showbox">
    <div class="loader">
        <svg class="circular" viewBox="25 25 50 50">
            <circle class="path" cx="50" cy="50" r="20" fill="none" stroke-width="2" stroke-miterlimit="10"/>
        </svg>
    </div>
</div>
{/block}
{block name="script"}
<script>
    $(function(){
        //上传
        $('.present' ).on('click',function(){
            var single = false;
            var content=$("textarea[name='content']").val();
            var img=$('.img1');
            var imglen=img.length;
            var images = [];
            for(var i =0 ;i< imglen ;i++){
                images.push(img.eq(i).attr('data-tab'));
            }
            if (imglen == 0) {
                images.push("");
            }
            if(content != "" ){
                single = true;
            }else{
                single = false;
                swal({
                    title: ' ',
                    text: '您还没有完成编辑！',
                    type: 'error',
                    confirmButtonText:'确定',
                    timer: 1500
                })
            }
            var data={
                content: content,
                images:images
            };
            if(single){
                // 弹窗
                swal({
                        title: ' ',
                        text: '我已完成编辑，马上发送！',
                        type: 'success',
                        showCancelButton: true,
                        confirmButtonText:'确定',
                        cancelButtonText: "取消",
                        closeOnConfirm: false
                    },
                    function(){
                        $(".sweet-alert .sa-confirm-button-container").css("display","none");
                        swal({
                            title: ' ',
                            text: '发送中...',
                            type: 'success',
                            timer:1500
                        });
                        setTimeout(function () {
                            $.ajax({
                                type:"post",
                                url: "{:Url('Feedback/publish')}",
                                data:data,
                                success:function(data){
                                    if (data.code == 1) {
                                        history.go(-1);
                                    }
                                }
                            });
                        },1500)
                    });
            }
        });
        //--------------------------------------------------------------------------
        //
        // 清除同一张图片再次上传bug
        function clearImg() {
            $("input[type = 'file']").remove();
        }

        function addImg() {
            var addImg = '<input type="file" class="hide" id="upimg" accept="image/*">';
            $(".imgs").append(addImg);
        }

        //--------------------------------------------------------------------------
//            图片预览
        $('.new' ).on('click',function(){
            var imglen = $('.img  .img1' ).length;
            var ua = navigator.userAgent.toLowerCase();
            var isiOS = (ua.indexOf('iphone') != -1) || (ua.indexOf('ipad') != -1);  // ios终端
            if(!isiOS){
                $(this).next("input").attr('capture','camera');
            }
            $('#upimg').click().off("change").on('change',function(){
                var size = ($(this)[0].files[0].size / 1024).toFixed(2);
                if(size <= 5120){
                    var img = $(this)[0].files[0];
                    var formData = new FormData();
                    formData.append("picture",img);
                    $.ajax({
                        type: "post",
                        url: "{:Url('File/uploadPicture')}",
                        data: formData,
                        processData : false,
                        contentType : false,
                        beforeSend: function(XMLHttpRequest){
                            $('.showbox').show();
                        },
                        success:function(data){
                            $('.showbox').hide();
                            clearImg();
                            var msg = $.parseJSON(data);
                            if(msg.code == 1){
                                //图片添加
                                if(imglen == 3){
                                    $('.add' ).hide()
                                }
                                $('.img').eq(imglen).removeClass('hide' )
                                    .append('<img class="img1" src='+msg.data.path+' alt="笔记图片" data-tab='+msg.data.id+'>');
                                if(imglen>=0){
//                                    添加删除按钮
                                    $('.x').on('click',function(){
                                        $(this).parents(".img").remove();
                                        $('.add').before('<div class="img fl hide"><div class="x"><img class="im2" src="/home/images/chacha.png"/></div></div>');
                                        if(imglen<4){
                                            $('.add' ).show();
                                        }
                                    })
                                }
                                imgresize();

                            } else {
                                swal({
                                    title: ' ',
                                    html: '上传失败',
                                    type: 'error',
                                    showConfirmButton:false,
                                    timer:1500
                                });
                            }
                            addImg();
                        }
                    });
                } else {
                    clearImg();
                    swal({
                        title: ' ',
                        text: '您的图片超过5M',
                        type: 'warning',
                        showConfirmButton:false,
                        timer:1500
                    });
                    addImg();
                }
            });

        });

        // 字数限定
        numlimit(400)
    });
    function imgresize(){
        setTimeout(function(){
            var img = $('.img .img1' );
            img.each(function(){
                if($(this).width() == $(this).height()){
                    $(this).height('17.3vw');
                    $(this).width('17.3vw');
                }else if($(this).width() > $(this).height()){
                    $(this).height('20.8vw' ).css({'left':-$(this).width()/2+78/2});
                }else{
                    $(this).width('20.8vw').css({'top':-$(this).height()/2+78/2});
                }
            });
        },100);
    }
    function numlimit(n){
        var textarea = $('textarea');
        var lock = false;
        textarea.on('compositionstart',function(){
            lock = true;
        });
        textarea.on('compositionend',function(){
            lock = false;
        });
        textarea.on('input',function(){
            if(!lock){
                //键盘输入
                var text = $(this).val();
                text = text.substring(0,n);
                var num = text.length;
                $(this).val(text);
                $('.contentnum span').text(num);
            }
        });
        textarea.bind("paste",function(){
            //黏贴输入
            var text = $(this).val();
            text = text.substring(0,n);
            var num = text.length;
            $(this).val(text);
            $('.contentnum span').text(num);
        }).css("ime-mode", "disabled"); //CSS设置输入法不可用
    }
</script>
{/block}