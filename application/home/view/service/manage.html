{extend name="public/common"}

{block name="style"}
<link rel="stylesheet" href="/home/css/service/manage.css">
<title>党员管理</title>
{/block}
{block name="body"}
<!--切换-->
<div class="tabs">
    <span class="tab">党员展示</span>
    <span class="tab">参会情况</span>
    <span class="tab" >流程展示</span>
</div>
<!--三个模块-->
    <div class="boxs">
        <!--党员展示模块-->
        <div class="box "  style="display:none;margin-top: -2.2vh;">
            <div class="search">
                <a href='/home/service/search.html'>请输入文字</a>
            </div>
            <div class="showLeft">
                <ul class="nav">
                    {volist name="dList" id="vo" key="k"}
                        {eq name="$k" value="1"}
                        <li class="active" data-id="{$vo.id}">{$vo.name}</li>
                        {else/}
                        <li data-id="{$vo.id}">{$vo.name}</li>
                        {/eq}
                    {/volist}
                </ul>
            </div>
            <div class="showRight">
                <!--<div class="title"><div>共有党员<span>48</span>位</div></div>-->
                <div class="userText">
                    <ul class="lists">
                        <!--<li><img data-original="/home/images/banner/1.jpg" class="lazy"><div>张然</div></li>-->
                        <!--<li><img data-original="/home/images/banner/1.jpg" class="lazy"><div>张然</div></li>-->
                    </ul>
                </div>
            </div>
        </div>
        <!--参会情况模块-->
        <div class="box" style="display:none;">
            <!--列表-->
            <div class="lists list2">
                {volist name="list" id="vo"}
                <a href="{:Url('meetdetail?id='.$vo.id)}" class="list">
                    <img data-original="{$vo.front_cover|get_cover='path'}" class="lazy">
                    <div class="lr">
                        <div class="title">
                            <p>{$vo.title}</p>
                        </div>
                        <span class="time">{$vo['create_time']|time_format='Y-m-d'}</span>
                        <span class="message">{$vo.views}</span>
                    </div>
                </a>
                {/volist}
            </div>
            <div class="loading hidden">
                <div class="typing_loader"></div>
            </div>
            <div class="tip"></div>
        </div>
        <!--流程展示模块-->
        <div class="box flow" style="display:none;">
            <!--列表-->
            <div class="lists">
                <a href="#" class="list">
                    <img data-original="/home/images/banner/1.jpg" alt="图片展示" class="lazy">
                    <div class="lr">
                        <p>党组织关系转接流程</p>
                    </div>
                </a>
                <a href="#" class="list">
                    <img data-original="/home/images/banner/1.jpg" alt="图片展示" class="lazy">
                    <div class="lr">
                        <p>党组织关系转接流程</p>
                    </div>
                </a>
                <a href="#" class="list">
                    <img data-original="/home/images/banner/1.jpg" alt="图片展示" class="lazy">
                    <div class="lr">
                        <p>党组织关系转接流程</p>
                    </div>
                </a>
                <a href="#" class="list">
                    <img data-original="/home/images/banner/1.jpg" alt="图片展示" class="lazy">
                    <div class="lr">
                        <p>党组织关系转接流程</p>
                    </div>
                </a>
                <a href="#" class="list">
                    <img data-original="/home/images/banner/1.jpg" alt="图片展示" class="lazy">
                    <div class="lr">
                        <p>党员发展流动党员管理、党组织基本制度执行流程介绍党员发展流动党员管理、党组织基本制度执行流程介绍</p>
                    </div>
                </a>
            </div>
        </div>
    </div>

    <div id="fixed">
        <div class="user">
            <div class="userImg"><img data-original="/home/images/banner/2.jpg" class="lazy"></div>
            <div class="userName">张然</div>
            <div class="userSex">性别：男</div>
            <div class="userSort"><span><img src="/home/images/service/icon_03.png" alt=""></span><span>联系方式</span><span><a href="tel:1356666888">1356666888</a></span></div>
            <div class="userSort"><span><img src="/home/images/service/icon_05.png" alt=""></span><span>出生年月</span><span>1973-05-12</span></div>
            <div class="userSort"><span><img src="/home/images/service/icon_02.png" alt=""></span><span>入党时间</span><span>1993-08-12</span></div>
            <div class="userSort"><span><img src="/home/images/service/icon_01.png" alt=""></span><span>所属党支部</span><span>山下湖党支部</span></div>
            <div class="userSort"><span><img src="/home/images/service/icon_07.png" alt=""></span><span>担任职务</span><span>组织部委员</span></div>
        </div>
        <img src="/home/images/service/icon_04.png" id="close">
    </div>

{/block}

{block name="script"}
<script src="/home/js/reset.js"></script>
<script>
    $(function(){
        $(".tab").on('click',function(){
            var index=$(this).index();
            $(this).addClass('active').siblings().removeClass('active');
            $(".box").eq(index).show().siblings().hide();
            localStorage.setItem('data',index);
        });
        var number = localStorage.getItem('data')==null?0:localStorage.getItem('data');
        $('.tabs .tab').removeClass('active');
        $('.tabs .tab').eq(number).addClass('active');

        // 党员展示初始化
        if (number == 0) {
            var num = getCookie("num") == null? 0 : getCookie("num");
            $(".showLeft li").eq(num).click();
        }

        $(".box").eq(number).show();

        $("img.lazy").lazyload({
            placeholder: "/home/images/loading.jpg",
            effect: "fadeIn",
            threshold : 500
        });
    var scrollNow = true;
        loadScroll();
    function loadScroll(){
        $(window ).off("scroll" ).on("scroll",function(){
            var number = localStorage.getItem('data')==null?0:localStorage.getItem('data');
            var dh = $(document).height();
            var end = $(window).height() + $(window ).scrollTop();
            var len = $('.list').length;
            var tip = $(".tip");
            var loading = $('.loading');
            if(dh == end && scrollNow){
                scrollNow = false;
                if(number==1){
                    $.ajax({
                        type:"post",
                        url: "{:Url('Service/indexMore')}",
                        data:{
                            length:len
                        },
                        beforeSend: function(XMLHttpRequest){
                            tip.hide();
                            loading.toggleClass('hidden');
                        },
                        success:function(data){
                            console.log(data)
                            loading.toggleClass('hidden');
                            tip.show();
                            if(data.code == 1){
                                addLists(data);

                                var dataLen =data.data.length;
                                if(data.data.length >= 2){
                                    tip.text('上拉加载更多');
                                } else {
                                    tip.text('没有更多了');
                                    $(window ).off("scroll");
                                }
                            }else{
                                tip.text('没有更多了');
                                $(window ).off("scroll");
                            }
                            scrollNow = true;
                        }
                    })
                }

            }
        })
    }
    function addLists(data){
        var html = '';
        var lists = data.data;
        var len = lists.length;
        if(number==1){
            for(var i = 0; i< len;i++){
                var list = lists[i];
                //var pid = $('.part div' ).eq(list.pid ).text();
                html +=
                    '<a href="/home/service/meetdetail/id'+ list.id+'.html" class="list">'+
                    '<img class="lazy" data-original='+list.path+'>'+
                    '<div class="lr">'+
                    '<div class="title"><p>'+list.title+'</p></div>'+
                    '<span class="time">'+list.time+'</span>'+
                    '<span class="message">'+list.views+'</span>'+
                    '</div>'+
                    '</a>'
            }
            $('.list2').append(html);
        }
    }
        $(document).scroll(function() {
            $("img.lazy").lazyload({
                placeholder: "/home/images/loading.jpg",
                effect: "fadeIn",
                threshold: 1
            });
        });
  });

//    党员展示
    var h = $(window).height()-$('.tab').height();
    $('.showLeft , .showRight').css('height',h);
    $('.showLeft li ').on('click',function(){
        setCookie("num",$(this).index());
        $('.showLeft li ').removeClass('active');
        $(this).addClass('active');
        var did = $(this).attr('data-id');
        $.ajax({
            type: "get",
            url: "{:Url('Service/getDepartmentMember')}",
            data: {did:did},
            success:function(data){
                if (data.code == 1) {
                    var data = JSON.parse(data.data);
                    console.log(data);
                    addLists1(data);
                    $("img.lazy").lazyload({
                        placeholder: "/home/images/loading.jpg",
                        effect: "fadeIn",
                        threshold: 1
                    });
                    $('.showRight li ').on('click',function(){
                        $('#fixed').stop().animate({
                            height:'100%'
                        },500);

                    });
                    $('#close ').on('click',function(){
                        $('#fixed').stop().animate({
                            height:0
                        },1);
                    });

                    // 数据循环
                    console.log(data);
                } else {
                    console.log('请求失败！');
                }

            }
        })

    });
    function addLists1(data){
        var html = '';
        var lists = data;
        var len = lists.length;
            for(var i = 0; i< len;i++){
                var list = lists[i];
                html += '<li><img data-original="/home/images/banner/1.jpg" class="lazy"><div>'+list.name+'</div></li>'

            }
            $('.showRight .lists').html(html);
    }
    $('.showRight li ').on('click',function(){
        $('#fixed').stop().animate({
            height:'100%'
        },500);

    });
    $('#close ').on('click',function(){
        $('#fixed').stop().animate({
            height:0
        },1);
    });




//    搜索接口 get url: "{:Url('Service/getMember')}" data: {searh:'搜索内容'}

    var search = $('.search>input');
    var lock = false;
    search.on('compositionstart',function(){
        lock = true;
    });
    search.on('compositionend',function(){
        lock = false;
    });
    search.on('input',function(){
        var this_ = this;
        var val = $(this_ ).val();
        var html = '';
        $.ajax({
            type:"get",
            url: "{:Url('Service/getMember')}",
            data:{
                search:val
            },
            beforeSend: function(XMLHttpRequest){},
            success:function(data){
                var result = data.data;
                var url = '';
                if(!data.data){
                    html += '<div class="result limit">无搜索结果</div>'
                }
                for(var obj in result){
                    html+= '<a href="/home/education/bookdetail/?id='+obj+'" class="result limit">'+result[obj]+'</a>';
                }
                $('.results' ).html(html);
            }

        });
//        }
    });
</script>
{/block}